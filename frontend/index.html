<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olist Analytics</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class' // Enable dark mode
        }
    </script>
    <style>
        /* Custom styles for table */
        th, td {
            @apply px-4 py-2 text-left;
        }
        thead th {
            @apply bg-gray-100 dark:bg-gray-700;
        }
        tbody tr:nth-child(even) {
            @apply bg-gray-50 dark:bg-gray-800;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans antialiased">

    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-6">Olist Analytics Dashboard</h1>

        <!-- Sales Summary Section -->
        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold">Sales Summary (Top 20)</h2>
                <p class="text-gray-600 dark:text-gray-400">Displaying data from <code class="bg-gray-100 dark:bg-gray-700 p-1 rounded">/sales_summary</code></p>
            </div>
            
            <!-- Loading and Error States -->
            <div id="loading-state" class="p-6 text-center">Loading data...</div>
            <div id="error-state" class="p-6 text-center text-red-500 hidden"></div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table id="sales-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 hidden">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Customer Unique ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Region</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Orders</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Sales</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Avg. Order Value</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Last Order Date</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.getElementById('sales-table');
            const tableBody = document.getElementById('sales-table-body');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');

            // API URL (assumes the API is running on localhost:8000)
            const apiUrl = 'http://localhost:8000/sales_summary?page=1&page_size=20';

            // Function to format currency
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            };

            // Function to format date
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString();
            };

            // Fetch data from API
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingState.classList.add('hidden');
                    table.classList.remove('hidden');

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No data found. Have you run the ETL?</td></tr>';
                        return;
                    }

                    // Populate table rows
                    data.forEach(item => {
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${item.customer_unique_id.substring(0, 12)}...</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${item.region || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${item.total_orders}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${formatCurrency(item.total_sales)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${formatCurrency(item.avg_order_value)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${formatDate(item.last_order_date)}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    loadingState.classList.add('hidden');
                    errorState.classList.remove('hidden');
                    errorState.textContent = 'Failed to load data. Is the API server running at http://localhost:8000?';
                });
        });
    </script>

</body>
</html>
